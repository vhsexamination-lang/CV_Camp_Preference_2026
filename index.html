<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CV Camp Deputation Portal</title>
    <link
      href="https://script.google.com/macros/s/AKfycbzJCpmyYX6TgbsFbxbDfxBOnNsPZYRDezaXQ4ZZ_o75QtFLgZ-isS7vgiHafQ5RllJ_Hg/exec"
    />
    <style>
      :root {
        --primary: #6366f1;
        --primary-hover: #4f46e5;
        --bg: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --warning-bg: #fff7ed;
        --warning-text: #9a3412;
        --success: #10b981;
        --danger-bg: #fef2f2;
        --danger-text: #991b1b;
        --danger-border: #f87171;
      }
      * {
        box-sizing: border-box;
        transition: all 0.2s ease;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg);
        color: var(--text-main);
        margin: 0;
        padding: 40px 20px;
      }
      .container {
        max-width: 850px;
        margin: 0 auto;
        background: var(--card-bg);
        padding: 40px;
        border-radius: 24px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
      }

      @media print {
        .no-print,
        button,
        .instruction-box {
          display: none !important;
        }
        #printHeader,
        #printFooter,
        #printTimestamp {
          display: block !important;
        }
        .container {
          box-shadow: none;
          width: 100%;
          border: none;
          padding: 0;
        }
        .review-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 25px;
          margin-top: 20px;
        }
        .review-item {
          border-bottom: 1px solid #cbd5e1;
          break-inside: avoid;
        }
      }

      header {
        text-align: center;
        margin-bottom: 35px;
      }
      h1 {
        font-weight: 800;
        font-size: 26px;
        color: #1e293b;
      }
      .instruction-box {
        margin-top: 20px;
        padding: 20px;
        background: var(--warning-bg);
        border-left: 4px solid #f97316;
        border-radius: 12px;
        text-align: left;
      }

      #closedMessage {
        display: none;
        text-align: center;
        padding: 40px 20px;
        background: var(--danger-bg);
        border: 2px solid var(--danger-border);
        border-radius: 16px;
        margin-top: 20px;
      }
      #closedMessage h2 {
        color: var(--danger-text);
        margin-top: 0;
      }
      #closedMessage p {
        color: var(--text-main);
        font-size: 16px;
        font-weight: 500;
        line-height: 1.5;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .full {
        grid-column: span 2;
      }
      .section-header {
        grid-column: span 2;
        display: flex;
        align-items: center;
        margin: 30px 0 10px 0;
      }
      .section-header span {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--primary);
        font-weight: 800;
      }
      .section-header::after {
        content: "";
        height: 1px;
        width: 100%;
        background: var(--border);
        margin-left: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      select,
      input {
        padding: 14px;
        border: 1.5px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        outline: none;
      }

      #penStatus {
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
        display: none;
      }

      #postSubmitAction {
        display: none;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        width: 100%;
      }
      .btn-success {
        background: var(--success);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
      }

      .review-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
      }
      .review-item {
        padding: 12px 8px;
        border-bottom: 1px solid #e2e8f0;
        break-inside: avoid;
      }
      .review-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 700;
        margin-bottom: 6px;
        letter-spacing: 0.5px;
      }
      .review-value {
        font-size: 15px;
        font-weight: 500;
        color: var(--text-main);
      }

      #printHeader,
      #printFooter,
      #printTimestamp {
        display: none;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="postSubmitAction" class="no-print">
        <div
          style="
            color: var(--success);
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 18px;
          "
        >
          âœ“ Application Submitted Successfully
        </div>
        <button
          class="btn-primary"
          onclick="
            generateTimestamp();
            window.print();
          "
          style="max-width: 300px"
        >
          Print Application Summary
        </button>
      </div>

      <div id="printHeader">
        <div
          style="font-weight: 700; font-size: 18px; text-transform: uppercase"
        >
          Board of Vocational Higher Secondary Examinations
        </div>
        <div style="font-size: 14px; margin-bottom: 20px">
          Housing Board Buildings, Santhinagar PO, Thiruvananthapuram - 695001
        </div>
      </div>

      <header>
        <h1 id="mainTitle">Board of VHS Examinations</h1>
        <h1 id="mainTitle">CV Camp Preference Form (March 2026)</h1>
        <div class="instruction-box no-print" id="instructionBox">
          <p>
            This form is intended for teachers deputed to Centralized Valuation
            (CV) camps for <strong>non-vocational subjects</strong>. Please
            ensure all entries are accurate and verified before final
            submission.
          </p>
        </div>
      </header>

      <div id="closedMessage" class="no-print">
        <h2>Portal Closed</h2>
        <p>
          The last date for the submission of the application is over.<br />Please
          contact the VHSE examination office for details (0471-2324015).
        </p>
      </div>

      <form id="entryForm">
        <div class="form-grid">
          <div class="section-header">
            <span>Personal & Professional Info</span>
          </div>
          <div class="form-group full">
            <label>Name (Applicant)</label>
            <input
              type="text"
              id="nameInput"
              name="Name"
              pattern="[a-zA-Z\s\.]+"
              required
            />
          </div>

          <div class="form-group">
            <label
              >PEN (6 or 7 Digits)
              <span id="penStatus">Checking database...</span></label
            >
            <input
              type="text"
              id="penInput"
              name="PEN"
              pattern="\d{6,7}"
              required
            />
          </div>

          <div class="form-group">
            <label>Mobile Number (10 Digits)</label>
            <input
              type="tel"
              id="mobileInput"
              name="Mobile"
              pattern="\d{10}"
              required
            />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="emailInput"
              name="Email"
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
              required
            />
          </div>
          <div class="form-group">
            <label>Date of Entry to Service</label>
            <input type="date" name="ServiceEntryDate" required />
          </div>

          <div class="section-header"><span>School Details</span></div>
          <div class="form-group">
            <label>District</label>
            <select id="district" name="District" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="form-group">
            <label>School Code</label>
            <select id="schoolCode" name="SchoolCode" required>
              <option value="">Select District First</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Name of School</label>
            <select id="schoolName" name="SchoolName" required>
              <option value="">Select District First</option>
            </select>
          </div>

          <div class="form-group">
            <label>Subject</label>
            <select id="subject" name="Subject" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Designation</label>
            <select id="designation" name="Designation" required>
              <option value="">Loading...</option>
            </select>
          </div>

          <div class="section-header">
            <span>Banking & CV Camp Preference</span>
          </div>
          <div class="form-group">
            <label>Account Number</label>
            <input
              type="text"
              id="accountInput"
              name="AccountNumber"
              required
            />
          </div>
          <div class="form-group">
            <label>IFSC</label>
            <input
              type="text"
              name="IFSC"
              pattern="[A-Za-z0-9]{11}"
              placeholder="e.g. SBIN0001234"
              oninput="this.value = this.value.replace(/\s/g, '').toUpperCase()"
              required
            />
          </div>
          <div class="form-group">
            <label>Preferred CV Camp</label>
            <select id="cvCamp" name="CVCamp" required>
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="form-group">
            <label>CV Camp Code</label>
            <select id="cvCampCode" name="CVCampCode" required>
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        <button
          type="button"
          class="btn-primary"
          onclick="showReview()"
          style="margin-top: 20px"
        >
          Preview Application
        </button>
      </form>

      <div id="reviewMode" style="display: none">
        <div
          id="reviewActionButtons"
          style="
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            margin-top: 10px;
          "
          class="no-print"
        >
          <button
            onclick="editForm()"
            style="
              background: #f1f5f9;
              border: none;
              padding: 16px;
              border-radius: 12px;
              flex: 1;
              cursor: pointer;
              font-weight: 600;
            "
          >
            Edit Details
          </button>
          <button
            id="finalBtn"
            onclick="finalSubmit()"
            class="btn-success"
            style="flex: 1"
          >
            Final Verify & Submit
          </button>
        </div>

        <div class="review-grid" id="reviewContent"></div>
      </div>

      <div
        id="printFooter"
        style="
          margin-top: 40px;
          border-top: 1px solid #cbd5e1;
          padding-top: 10px;
        "
      >
        <p style="font-size: 12px; color: #64748b">
          You may print this document for your personal use and future
          reference.
        </p>
        <p style="font-size: 12px; color: #64748b; font-weight: bold">
          Board of Vocational Higher Secondary Examinations, Thiruvananthapuram
        </p>
      </div>
      <div
        id="printTimestamp"
        style="font-size: 11px; color: #94a3b8; margin-top: 10px"
      ></div>
    </div>

    <script>
      // MAKE SURE THIS IS YOUR LIVE /exec URL
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbyZLW36-fbL5Jqr7TI-JwH9sEiPc5VcvrFRU_ipod4pON4Px10Rj6S3cA-Jd-NXN-PpeA/exec";

      let schoolData = [];
      let campData = [];

      function populateDropdown(selectId, dataArray) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Select --</option>';
        dataArray.forEach((item) => {
          let opt = document.createElement("option");
          opt.value = opt.textContent = item;
          select.appendChild(opt);
        });
      }

      function setAllDropdownsError(msg) {
        const selects = [
          "district",
          "subject",
          "designation",
          "cvCamp",
          "cvCampCode",
        ];
        selects.forEach(
          (id) =>
            (document.getElementById(id).innerHTML =
              `<option value="">${msg}</option>`),
        );
      }

      // Initialize Page
      window.onload = () => {
        fetch(SCRIPT_URL, { method: "GET", redirect: "follow" })
          .then((res) => res.json())
          .then((data) => {
            if (data.backendError) {
              alert("Google Sheet Error: " + data.backendError);
              setAllDropdownsError("Backend Error");
              return;
            }

            if (data.isOpen === false) {
              document.getElementById("entryForm").style.display = "none";
              document.getElementById("instructionBox").style.display = "none";
              document.getElementById("closedMessage").style.display = "block";
              return;
            }

            schoolData = data.mapping;
            campData = data.campMapping;

            populateDropdown("district", data.districts);
            populateDropdown("subject", data.subjects);
            populateDropdown("designation", data.designations);

            populateDropdown(
              "cvCamp",
              campData.map((c) => c.name),
            );
            populateDropdown(
              "cvCampCode",
              campData.map((c) => c.code),
            );
          })
          .catch((error) => {
            console.error("Fetch Error:", error);
            setAllDropdownsError("Network Error. Reload page.");
          });
      };

      // --- AUTO-FORMATTING LOGIC (Runs when user clicks away from a field) ---

      // 1. Name Formatter
      document
        .getElementById("nameInput")
        .addEventListener("blur", function () {
          let val = this.value.replace(/\./g, "").trim().replace(/\s+/g, " "); // Strip periods & extra spaces
          if (val) {
            this.value = val
              .split(" ")
              .map((word) => {
                if (word.length <= 2) return word.toUpperCase(); // Force 1-2 letters to UPPERCASE
                return (
                  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ); // Capitalize normal words
              })
              .join(" ");
          }
        });

      // 2. Email Formatter
      document
        .getElementById("emailInput")
        .addEventListener("blur", function () {
          this.value = this.value.replace(/\s/g, "").toLowerCase(); // Strip spaces & force lowercase
        });

      // 3. Number Formatter (Strips anything that isn't a digit)
      const formatAsNumbers = function () {
        this.value = this.value.replace(/\D/g, "");
      };
      document
        .getElementById("penInput")
        .addEventListener("blur", formatAsNumbers);
      document
        .getElementById("mobileInput")
        .addEventListener("blur", formatAsNumbers);
      document
        .getElementById("accountInput")
        .addEventListener("blur", formatAsNumbers);

      // -------------------------------------------------------------------------

      // --- Live PEN Checking Logic ---
      const penInput = document.getElementById("penInput");
      const penStatus = document.getElementById("penStatus");
      let validatedPen = "";
      let isChecking = false;
      let isResubmission = false;

      penInput.addEventListener("input", function () {
        const currentPen = this.value.trim();

        if (
          (currentPen.length === 6 || currentPen.length === 7) &&
          /^\d+$/.test(currentPen) &&
          currentPen !== validatedPen &&
          !isChecking
        ) {
          isChecking = true;
          penStatus.style.display = "inline";
          penStatus.style.color = "#f59e0b";
          penStatus.innerText = "Checking database...";

          const separator = SCRIPT_URL.includes("?") ? "&" : "?";
          fetch(SCRIPT_URL + separator + "action=checkPEN&pen=" + currentPen, {
            method: "GET",
            redirect: "follow",
          })
            .then((res) => res.json())
            .then((data) => {
              isChecking = false;

              if (data.backendError) {
                penStatus.style.color = "red";
                penStatus.innerText = "Database check failed.";
                setTimeout(() => (penStatus.style.display = "none"), 3000);
                return;
              }

              penStatus.style.display = "none";

              if (data.exists) {
                const confirmMsg = `Warning: You previously submitted an application on ${data.timestamp}.\n\nContinuing and submitting this form will overwrite your previous entry.\n\nDo you want to proceed?`;

                if (confirm(confirmMsg)) {
                  validatedPen = currentPen;
                  isResubmission = true;
                } else {
                  penInput.value = "";
                  validatedPen = "";
                  isResubmission = false;
                }
              } else {
                validatedPen = currentPen;
                isResubmission = false;
              }
            })
            .catch((err) => {
              isChecking = false;
              penStatus.style.color = "red";
              penStatus.innerText = "Network error.";
              setTimeout(() => (penStatus.style.display = "none"), 3000);
            });
        }
      });

      // --- Dependent Logic for Schools ---
      document
        .getElementById("district")
        .addEventListener("change", function () {
          const filtered = schoolData.filter((s) => s.dist === this.value);
          const nameSel = document.getElementById("schoolName");
          const codeSel = document.getElementById("schoolCode");
          nameSel.innerHTML = codeSel.innerHTML =
            '<option value="">-- Select --</option>';
          filtered.forEach((s) => {
            nameSel.add(new Option(s.name, s.name));
            codeSel.add(new Option(s.code, s.code));
          });
        });

      document
        .getElementById("schoolCode")
        .addEventListener("change", function () {
          const matchingSchool = schoolData.find(
            (s) => String(s.code) === String(this.value),
          );
          if (matchingSchool)
            document.getElementById("schoolName").value = matchingSchool.name;
        });

      document
        .getElementById("schoolName")
        .addEventListener("change", function () {
          const matchingSchool = schoolData.find((s) => s.name === this.value);
          if (matchingSchool)
            document.getElementById("schoolCode").value = matchingSchool.code;
        });

      // --- Dependent Logic for CV Camps ---
      document.getElementById("cvCamp").addEventListener("change", function () {
        const matchingCamp = campData.find(
          (c) => String(c.name) === String(this.value),
        );
        if (matchingCamp)
          document.getElementById("cvCampCode").value = matchingCamp.code;
      });

      document
        .getElementById("cvCampCode")
        .addEventListener("change", function () {
          const matchingCamp = campData.find(
            (c) => String(c.code) === String(this.value),
          );
          if (matchingCamp)
            document.getElementById("cvCamp").value = matchingCamp.name;
        });

      // --- Submission & Review Scripts ---
      function showReview() {
        const form = document.getElementById("entryForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        let html = "";
        new FormData(form).forEach((val, key) => {
          html += `<div class="review-item"><div class="review-label">${key}</div><div class="review-value">${val || "-"}</div></div>`;
        });

        document.getElementById("mainTitle").innerText = "Application Summary";
        document.getElementById("instructionBox").style.display = "none";
        document.getElementById("reviewContent").innerHTML = html;
        document.getElementById("entryForm").style.display = "none";
        document.getElementById("reviewMode").style.display = "block";
      }

      function editForm() {
        document.getElementById("mainTitle").innerText =
          "CV Camp Preference Form (March 2026)";
        document.getElementById("instructionBox").style.display = "block";
        document.getElementById("entryForm").style.display = "block";
        document.getElementById("reviewMode").style.display = "none";
      }

      function finalSubmit() {
        if (isResubmission) {
          const finalWarning = confirm(
            "FINAL WARNING: You are about to completely overwrite your previously submitted application.\n\nAre you sure you want to submit this new entry?",
          );
          if (!finalWarning) return;
        }

        const btn = document.getElementById("finalBtn");
        btn.disabled = true;
        btn.innerText = "Submitting...";

        fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          body: new FormData(document.getElementById("entryForm")),
        })
          .then(() => {
            document.getElementById("postSubmitAction").style.display = "block";
            document.getElementById("reviewActionButtons").style.display =
              "none";
            window.scrollTo(0, 0);
          })
          .catch((error) => {
            alert("There was an error submitting. Please try again.");
            btn.disabled = false;
            btn.innerText = "Final Verify & Submit";
          });
      }

      function generateTimestamp() {
        document.getElementById("printTimestamp").innerText =
          "Printed on: " + new Date().toLocaleString();
      }
    </script>
  </body>
</html>